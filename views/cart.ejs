<%- include('./partials/header') %>

<div class="w-full min-h-screen flex flex-col px-6 sm:px-10 py-12 gap-10 bg-gradient-to-br from-gray-50 to-gray-100">

    <!-- Top Summary Bar -->
    <div id="summary-bar" class="sticky top-0 bg-white shadow-lg p-4 rounded-xl hidden">
        <div class="flex justify-between items-center">
            <h2 class="text-lg sm:text-xl font-semibold text-gray-700">Total Selected: ₹ <span id="grand-total">0</span></h2>
            <button id="buy-btn" 
                class="px-4 py-2 bg-yellow-500 font-medium rounded-lg hover:bg-yellow-600 text-sm text-white transition-colors duration-200">
                Proceed to Buy
            </button>
        </div>
    </div>

    <% if(user.cart.length === 0) { %>
        <p class="text-3xl font-extrabold text-center text-blue-600 drop-shadow-md tracking-wide hover:text-blue-700 transition duration-300 ease-in-out transform hover:scale-105">
            No items in cart
        </p>
    <% } %>

    <% user.cart.forEach((item, index) => { 
        let unitPrice = item.price - item.discount + 20 + 25; // Added shipping fee (₹25)
    %>
        <div class="w-full flex flex-col sm:flex-row gap-6 mb-6 border-b pb-6">

            <!-- Left Product Card -->
            <div class="w-full sm:w-[25%] rounded-xl overflow-hidden relative shadow-lg bg-white">
                <input type="checkbox" 
                       name="selectedProducts[]" 
                       value="<%= item._id %>" 
                       class="absolute top-3 left-3 w-5 h-5 product-check accent-blue-600"
                       data-price="<%= unitPrice %>"
                       data-index="<%= index %>"
                       id="product-<%= index %>">

                <div class="w-full flex justify-center items-center h-56 bg-[<%= item.bgcolor %>]">
                    <img class="h-36 object-contain"
                        src="data:<%= item.mimetype %>;base64,<%= item.image.toString('base64') %>"
                        alt="<%= item.name %>">
                    <a href="/removeproduct/<%= item._id %>" class="absolute top-3 right-3">
                        <img class="h-6 w-6 object-contain" src="/images/bin.png" alt="bin image">
                    </a>
                </div>

                <div class="w-full flex justify-between px-4 py-3 bg-[<%= item.panelcolor %>]">
                    <h3 class="text-lg font-semibold text-gray-800"><%= item.name %></h3>
                    <div class="flex items-center gap-2">
                        <i class="w-6 h-6 bg-white flex rounded-full items-center justify-center ri-add-line text-sm cursor-pointer quantity-increase hover:bg-gray-100"
                           data-index="<%= index %>"></i>

                        <div class="px-2 py-1 rounded bg-white text-black text-sm font-medium quantity-value"
                             id="quantity-<%= index %>">1</div>

                        <i class="w-6 h-6 bg-white flex rounded-full items-center justify-center ri-subtract-line text-sm cursor-pointer quantity-decrease hover:bg-gray-100"
                           data-index="<%= index %>"></i>
                    </div>
                </div>

                <div class="flex items-center text-white justify-between px-4 py-3 bg-[<%= item.textcolor %>]">
                    <h4 class="text-sm font-medium">Net Total</h4>
                    <h2 class="text-sm font-semibold product-nettotal" id="nettotal-<%= index %>">₹ <%= unitPrice %></h2>
                </div>
            </div>

            <!-- Right Price Breakdown -->
            <div class="w-full sm:w-[75%] bg-white p-6 rounded-xl shadow-lg">
                <h3 class="text-lg sm:text-xl font-semibold text-gray-800">Price Breakdown</h3>
                <div class="px-4 sm:px-6 mt-3 text-sm text-gray-600">
                    <div class="flex mt-2">
                        <h4 class="w-1/3 font-medium">Total MRP</h4>
                        <h4>₹ <%= item.price %></h4>
                    </div>
                    <div class="flex mt-2">
                        <h4 class="w-1/3 font-medium">Discount on MRP</h4>
                        <h4>₹ <%= Number(item.discount) %></h4>
                    </div>
                    <div class="flex mt-2">
                        <h4 class="w-1/3 font-medium">Platform Fee</h4>
                        <h4>₹ 20</h4>
                    </div>
                    <div class="flex mt-2">
                        <h4 class="w-1/3 font-medium">Shipping Fee</h4>
                        <h4>₹ 25</h4>
                    </div>
                </div>
                <div class="w-full h-[1px] bg-gray-300 mt-6"></div>
                <div class="flex mt-4">
                    <h3 class="w-1/3 text-base font-semibold text-gray-800">Total Amount</h3>
                    <h3 class="font-semibold text-base text-green-600 product-total" id="total-<%= index %>">
                        ₹ <%= unitPrice %>
                    </h3>
                </div>
            </div>
        </div>
    <% }) %>

</div>

<script>
    const checkboxes = document.querySelectorAll(".product-check");
    const grandTotalEl = document.getElementById("grand-total");
    const summaryBar = document.getElementById("summary-bar");

    const increaseBtns = document.querySelectorAll(".quantity-increase");
    const decreaseBtns = document.querySelectorAll(".quantity-decrease");

    increaseBtns.forEach(btn => {
        btn.addEventListener("click", () => {
            const index = btn.dataset.index;
            updateQuantity(index, 1);
        });
    });

    decreaseBtns.forEach(btn => {
        btn.addEventListener("click", () => {
            const index = btn.dataset.index;
            updateQuantity(index, -1);
        });
    });

    checkboxes.forEach(cb => cb.addEventListener("change", updateGrandTotal));

    function updateQuantity(index, change) {
        const quantityEl = document.getElementById("quantity-" + index);
        let quantity = parseInt(quantityEl.textContent);
        if (quantity + change < 1) return;

        quantity += change;
        quantityEl.textContent = quantity;

        const productCheckbox = document.getElementById("product-" + index);
        const unitPrice = parseFloat(productCheckbox.dataset.price);
        document.getElementById("nettotal-" + index).textContent = "₹ " + (unitPrice * quantity).toFixed(2);
        document.getElementById("total-" + index).textContent = "₹ " + (unitPrice * quantity).toFixed(2);
        updateGrandTotal();
    }

    function updateGrandTotal() {
        let total = 0;
        checkboxes.forEach(box => {
            if (box.checked) {
                const index = box.dataset.index;
                const quantity = parseInt(document.getElementById("quantity-" + index).textContent);
                const price = parseFloat(box.dataset.price);
                total += price * quantity;
            }
        });

        grandTotalEl.textContent = total.toFixed(2);
        summaryBar.style.display = total > 0 ? "block" : "none";
    }

    document.getElementById("buy-btn").addEventListener("click", () => {
        let selected = [];
        let total = 0;

        document.querySelectorAll(".product-check:checked").forEach(cb => {
            const index = cb.dataset.index;
            const quantity = parseInt(document.getElementById("quantity-" + index).textContent);
            const price = parseFloat(cb.dataset.price);

            selected.push({ id: cb.value, qty: quantity });
            total += price * quantity;
        });

        fetch("/checkout", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ products: selected, totalCost: total })
        })
        .then(res => {
            if (res.redirected) {
                window.location.href = res.url; 
            }
        })
        .catch(err => console.error(err));
    });
</script>

<%- include('./partials/footer') %>