<%- include('./partials/header') %>

<div class="w-full min-h-screen flex flex-col px-10 py-10 gap-8">

    <!-- Top Summary Bar -->
    <div id="summary-bar" class="sticky top-0 bg-white shadow-md p-3 rounded-md hidden">
        <div class="flex justify-between items-center">
            <h2 class="text-lg">Total Selected: ₹ <span id="grand-total">0</span></h2>
            <button id="buy-btn" 
                class="px-4 py-1.5 bg-yellow-500 font-medium rounded-md hover:bg-yellow-600 text-sm">
                Proceed to Buy
            </button>
        </div>
    </div>

    <% user.cart.forEach((item, index) => { 
        let unitPrice = item.price - item.discount + 20; 
    %>
        <div class="w-full flex gap-6 mb-6 border-b pb-6">

            <!-- Left Product Card -->
            <div class="w-[25%] rounded-md overflow-hidden relative">
                <input type="checkbox" 
                       name="selectedProducts[]" 
                       value="<%= item._id %>" 
                       class="absolute top-2 left-2 w-4 h-4 product-check"
                       data-price="<%= unitPrice %>"
                       data-index="<%= index %>"
                       id="product-<%= index %>">

                <div class="w-full flex justify-center items-center h-56 bg-[<%= item.bgcolor %>]">
                    <img class="h-36 object-contain"
                        src="data:<%= item.mimetype %>;base64,<%= item.image.toString('base64') %>"
                        alt="<%= item.name %>">
                    <a href="/removeproduct/<%= item._id %>" class="absolute top-2 right-2">
                        <img class="h-6 w-6 object-contain" src="/images/bin.png" alt="bin image">
                    </a>
                </div>

                <div class="w-full flex justify-between px-3 py-2 bg-[<%= item.panelcolor %>]">
                    <h3 class="text-lg font-medium"><%= item.name %></h3>
                    <div class="flex items-center gap-1">
                        <i class="w-5 h-5 bg-white flex rounded-full items-center justify-center ri-add-line text-xs cursor-pointer quantity-increase"
                           data-index="<%= index %>"></i>

                        <div class="px-1.5 py-0.5 rounded bg-white text-black text-xs quantity-value"
                             id="quantity-<%= index %>">1</div>

                        <i class="w-5 h-5 bg-white flex rounded-full items-center justify-center ri-subtract-line text-xs cursor-pointer quantity-decrease"
                           data-index="<%= index %>"></i>
                    </div>
                </div>

                <div class="flex items-center text-white justify-between px-3 py-2 bg-[<%= item.textcolor %>]">
                    <h4 class="text-sm">Net Total</h4>
                    <h2 class="text-sm product-nettotal" id="nettotal-<%= index %>">₹ <%= unitPrice %></h2>
                </div>
            </div>

            <!-- Right Price Breakdown -->
            <div class="w-[75%]">
                <h3 class="text-lg font-medium">Price Breakdown</h3>
                <div class="px-6 mt-3 text-sm">
                    <div class="flex mt-1">
                        <h4 class="w-1/3">Total MRP</h4>
                        <h4>₹ <%= item.price %></h4>
                    </div>
                    <div class="flex mt-1">
                        <h4 class="w-1/3">Discount on MRP</h4>
                        <h4>₹ <%= Number(item.discount) %></h4>
                    </div>
                    <div class="flex mt-1">
                        <h4 class="w-1/3">Platform Fee</h4>
                        <h4>₹ 20</h4>
                    </div>
                    <div class="flex mt-1">
                        <h4 class="w-1/3">Shipping Fee</h4>
                        <h4>FREE</h4>
                    </div>
                </div>
                <div class="w-full h-[1px] bg-gray-400 mt-6"></div>
                <div class="flex mt-3">
                    <h3 class="w-1/3 text-base">Total Amount</h3>
                    <h3 class="font-semibold text-base text-green-600 product-total" id="total-<%= index %>">
                        ₹ <%= unitPrice %>
                    </h3>
                </div>
            </div>
        </div>
    <% }) %>

</div>

<script>
    const checkboxes = document.querySelectorAll(".product-check");
    const grandTotalEl = document.getElementById("grand-total");
    const summaryBar = document.getElementById("summary-bar");

    const increaseBtns = document.querySelectorAll(".quantity-increase");
    const decreaseBtns = document.querySelectorAll(".quantity-decrease");

    increaseBtns.forEach(btn => {
        btn.addEventListener("click", () => {
            const index = btn.dataset.index;
            updateQuantity(index, 1);
        });
    });

    decreaseBtns.forEach(btn => {
        btn.addEventListener("click", () => {
            const index = btn.dataset.index;
            updateQuantity(index, -1);
        });
    });

    checkboxes.forEach(cb => cb.addEventListener("change", updateGrandTotal));

    function updateQuantity(index, change) {
        const quantityEl = document.getElementById("quantity-" + index);
        let quantity = parseInt(quantityEl.textContent);
        if (quantity + change < 1) return;

        quantity += change;
        quantityEl.textContent = quantity;

        const productCheckbox = document.getElementById("product-" + index);
        const unitPrice = parseFloat(productCheckbox.dataset.price);
        document.getElementById("nettotal-" + index).textContent = "₹ " + (unitPrice * quantity);
        document.getElementById("total-" + index).textContent = "₹ " + (unitPrice * quantity);
        updateGrandTotal();
    }

    function updateGrandTotal() {
        let total = 0;
        checkboxes.forEach(box => {
            if (box.checked) {
                const index = box.dataset.index;
                const quantity = parseInt(document.getElementById("quantity-" + index).textContent);
                const price = parseFloat(box.dataset.price);
                total += price * quantity;
            }
        });

        grandTotalEl.textContent = total;
        summaryBar.style.display = total > 0 ? "block" : "none";
    }

    document.getElementById("buy-btn").addEventListener("click", () => {
        let selected = [];
        let total = 0;

        document.querySelectorAll(".product-check:checked").forEach(cb => {
            const index = cb.dataset.index;
            const quantity = parseInt(document.getElementById("quantity-" + index).textContent);
            const price = parseFloat(cb.dataset.price);

            selected.push({ id: cb.value, qty: quantity });
            total += price * quantity;
        });

        fetch("/checkout", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ products: selected, totalCost: total })
        })
        .then(res => {
            if (res.redirected) {
                window.location.href = res.url; // follow redirect to /myorders
            }
        })
        .catch(err => console.error(err));


    });
</script>

<%- include('./partials/footer') %>
